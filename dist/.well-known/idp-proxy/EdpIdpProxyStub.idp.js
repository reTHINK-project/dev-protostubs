!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("activate",[],t):"object"==typeof exports?exports.activate=t():e.activate=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=o(1),r=o(2),i=o(3);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function u(e,t,o){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,o){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=f(e)););return e}(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(o):r.value}})(e,t,o||e)}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l={name:"EdpIdpProxyProtoStub",language:"javascript",description:"IDPProxy for EDP Distribuição IDP",signature:"",configuration:{},constraints:{browser:!0},interworking:!0,objectName:"edpdistribuicao.pt"},d=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),a(this,f(t).call(this))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(t,i["a"]),function(e,t,o){t&&c(e.prototype,t),o&&c(e,o)}(t,[{key:"_start",value:function(e,o,i){i.domain="edpdistribuicao.pt",i.idpUrl="domain-idp://edpdistribuicao.pt",i.idpProxy=n.a,i.idpInfo=r.d,i.apiInfo=r.d,i.authEndpoint=r.c,i.accessTokenInput=r.b,i.accessTokenEndpoint=r.c,i.accessTokenErrorMsg=r.a,u(f(t.prototype),"_init",this).call(this,e,o,i)}},{key:"descriptor",get:function(){return l}},{key:"name",get:function(){return l.name}}]),t}();t.default=d},function(e,t,o){"use strict";o.d(t,"a",function(){return s});var n,r;location.protocol,location.hostname,""!==location.port&&location.port;function i(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\#&?]"+t+"=([^&#]*)").exec(e);return null!==o&&o[1]}var s={getAccessTokenAuthorisationEndpoint:function(e,t){return console.log("[Edp.IdpProxy.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[Edp.IdpProxy.getAccessTokenAuthorisationEndpoint:resources]",t),r=e.authEndpoint,new Promise(function(e,o){e(r(t))},function(e){reject(e)})},getAccessToken:function(e,t,o){return console.log("[OIDC.getAccessToken:config]",e),console.log("[OIDC.getAccessToken:login]",o),e.accessTokenEndpoint,n=e.domain,new Promise(function(r,s){var c="true"===i(o,"isValid"),a="true"===i(o,"consent");if(a&c){var u=a,f=31536e5+Math.floor(Date.now()/1e3);r(function(e,t,o,r,i){var s={domain:n,resources:e,accessToken:t,expires:o,input:r};return i&&(s.refresh=i),s}(t,u,f,o))}else s(e.accessTokenErrorMsg(c,a))},function(e){reject(e)})}}},function(e,t,o){"use strict";o.d(t,"d",function(){return r}),t.c=function(e){return r.authorisationEndpoint+"client_id="+e+"&redirect_uri="+n},t.b=function(e){return{info:e}},t.a=function(e,t){return e?r.consentErroMsg:r.invalidCPEErroMsg};var n=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),r={authorisationEndpoint:"https://fe-dot-online-dist-edp-pre.appspot.com/sharing-cities/login?",revokeEndpoint:"https://fe-dot-online-dist-edp-pre.appspot.com/sharing-cities/revoke?",domain:"edpdistribuicao.pt",invalidCPEErroMsg:"Lamentamos mas o CPE indicado não está localizado no Concelho de Lisboa",consentErroMsg:"Não deu consentimento para disponibilizar os seus dados de consumo de energia eléctrica"}},function(e,t,o){"use strict";function n(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var r,i,s,c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),console.log("[AbstractIdpProxy] constructor")}return function(e,t,o){t&&n(e.prototype,t),o&&n(e,o)}(e,[{key:"_init",value:function(e,t,o){var n=this;n.runtimeProtoStubURL=e,n.messageBus=t,n.config=o,r=o.idpProxy,i=o.convertUserProfile,s=o.accessTokenInput,n.messageBus.addListener("*",function(e){e.to===o.idpUrl&&n.requestToIdp(e)}),n._sendStatus("created")}},{key:"requestToIdp",value:function(e){var t=this,o=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":r.generateAssertion(t.config,o.contents,o.origin,o.usernameHint).then(function(o){o.userProfile=i(o.userProfile),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"validateAssertion":r.validateAssertion(t.config,o.assertion,o.origin).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o)});break;case"refreshAssertion":r.refreshAssertion(o.identity).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o,value,401)});break;case"getAccessTokenAuthorisationEndpoint":r.getAccessTokenAuthorisationEndpoint(t.config,o.resources).then(function(o){t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"getAccessToken":r.getAccessToken(t.config,o.resources,o.login).then(function(o){console.info("OIDC.getAccessToken result: ",o),o.input=s(o.input),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"refreshAccessToken":r.refreshAccessToken(t.config,o.token).then(function(o){console.info("OIDC.refreshAccessToken result: ",o),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)});break;case"revokeAccessToken":r.revokeAccessToken(t.config,o.token).then(function(o){console.info("OIDC.revokeAccessToken result: ",o),t.replyMessage(e,o)},function(o){t.replyMessage(e,o,401)})}}},{key:"replyMessage",value:function(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:200,n={id:e.id,type:"response",to:e.from,from:e.to,body:{code:o}};o<300?n.body.value=t:n.body.description=t,console.log("[AbstractIdpProxyProtoStub.replyMessage] ",n),this.messageBus.postMessage(n)}},{key:"_sendStatus",value:function(e,t){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var o={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};t&&(o.body.desc=t),this.messageBus.postMessage(o)}}]),e}();t.a=c}]).default});