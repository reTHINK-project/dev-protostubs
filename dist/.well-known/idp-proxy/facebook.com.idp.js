System.register([],function(e){return{execute:function(){e(function(e){var n={};function o(t){if(n[t])return n[t].exports;var s=n[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}return o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,n){if(1&n&&(e=o(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)o.d(t,s,function(n){return e[n]}.bind(null,s));return t},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="",o(o.s=7)}([function(e,n,o){"use strict";let t,s,r;n.a=class{constructor(){console.log("[AbstractIdpProxy] constructor")}_init(e,n,o){let i=this;i.runtimeProtoStubURL=e,i.messageBus=n,i.config=o,t=o.idpProxy,s=o.convertUserProfile,r=o.accessTokenInput,i.messageBus.addListener("*",function(e){e.to===o.idpUrl&&i.requestToIdp(e)}),i._sendStatus("created")}requestToIdp(e){let n=this,o=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":t.generateAssertion(n.config,o.contents,o.origin,o.usernameHint).then(function(o){o.userProfile=s(o.userProfile),n.replyMessage(e,o)},function(o){n.replyMessage(e,o,401)});break;case"validateAssertion":t.validateAssertion(n.config,o.assertion,o.origin).then(function(o){n.replyMessage(e,o)},function(o){n.replyMessage(e,o)});break;case"refreshAssertion":t.refreshAssertion(o.identity).then(function(o){n.replyMessage(e,o)},function(o){n.replyMessage(e,o,value,401)});break;case"getAccessTokenAuthorisationEndpoint":t.getAccessTokenAuthorisationEndpoint(n.config,o.resources).then(function(o){n.replyMessage(e,o)},function(o){n.replyMessage(e,o,401)});break;case"getAccessToken":t.getAccessToken(n.config,o.resources,o.login).then(function(o){console.info("OIDC.getAccessToken result: ",o),o.input=r(o.input),n.replyMessage(e,o)},function(o){n.replyMessage(e,o,401)});break;case"refreshAccessToken":t.refreshAccessToken(n.config,o.token).then(function(o){console.info("OIDC.refreshAccessToken result: ",o),n.replyMessage(e,o)},function(o){n.replyMessage(e,o,401)});break;case"revokeAccessToken":t.revokeAccessToken(n.config,o.token).then(function(o){console.info("OIDC.revokeAccessToken result: ",o),n.replyMessage(e,o)},function(o){n.replyMessage(e,o,401)})}}replyMessage(e,n,o=200){let t={id:e.id,type:"response",to:e.from,from:e.to,body:{code:o}};o<300?t.body.value=n:t.body.description=n,console.log("[AbstractIdpProxyProtoStub.replyMessage] ",t),this.messageBus.postMessage(t)}_sendStatus(e,n){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;let o={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};n&&(o.body.desc=n),this.messageBus.postMessage(o)}}},function(e,n,o){"use strict";let t,s,r,i,c,a,u,l;o.d(n,"a",function(){return h});function f(e,n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");let o=new RegExp("[\\#&?]"+n+"=([^&#]*)").exec(e);return null===o?"":o[1]}function p(e,n){let o=new XMLHttpRequest;return"withCredentials"in o?o.open(e,n,!0):"undefined"!=typeof XDomainRequest?(o=new XDomainRequest).open(e,n):o=null,new Promise(function(e,n){o?(o.onreadystatechange=function(t){if(console.log("[OAUTH2.sendHTTPRequest] response ",t),4===o.readyState)if(200===o.status){let n=JSON.parse(o.responseText);e(n)}else 400===o.status?n("There was an error processing the token"):401===o.status?n("Not Authorised"):n("something else other than 200 was returned")},o.send()):n("CORS not supported")})}let d=function(e,n,o){return new Promise(function(s,r){p("GET",t(o)).then(function(t){console.log("[OAUTH2.generateAssertion] obtained user profile ",t);let r=btoa(JSON.stringify({tokenID:o.access_token,tokenIDJSON:t,publicKey:e}));console.log("[OAUTH2.generateAssertion] atob assertion:",atob(r));let c={assertion:r,idp:{domain:i,protocol:"OAUTH2"},expires:n,userProfile:t};console.log("[OAUTH2.generateAssertion] returning: ",JSON.stringify(c)),s(c)})})},g=function(e){let n=f(e,"expires_in");return n?n+=Math.floor(Date.now()/1e3):n=31536e5+Math.floor(Date.now()/1e3),n},k=function(e,n,o,t,s){let r={domain:i,resources:e,accessToken:n,expires:o,input:t};return s&&(r.refresh=s),r},h={validateAssertion:(e,n,o)=>(console.info("[OAUTH2.validateAssertion] assertion: ",atob(n)),t=e.userInfoEndpoint,i=e.domain,new Promise(function(o,t){let s=atob(n),r=JSON.parse(s);p("GET",e.validateAssertionEndpoint({access_token:r.tokenID,input:r.tokenIDJSON})).then(n=>{JSON.stringify(n)===JSON.stringify(r.tokenIDJSON)?o({identity:e.convertUserProfile(n).id,contents:r.publicKey}):t("invalid")}).catch(e=>{t(e)})})),generateAssertion:(e,n,o,c)=>{console.log("[OAUTH2.generateAssertion:config]",e),console.log("[OAUTH2.generateAssertion:contents]",n),console.log("[OAUTH2.generateAssertion:origin]",o),console.log("[OAUTH2.generateAssertion:hint]",c),t=e.userInfoEndpoint,s=e.tokenEndpoint,r=e.authorisationEndpoint,i=e.domain;return new Promise(function(e,o){if(c){let o=f(c,"expires_in");o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3);let t=f(c,"access_token");e(t?d(n,o,{access_token:t}):function(e,n,o){return new Promise(function(t,r){let i=f(o,"code");i||r("[OAUTH2.generateAssertionWithCode] code not returned by the authentication: ",o),p("POST",s(i)).then(function(o){o.hasOwnProperty("access_token")?t(d(e,n,o)):r("[OAUTH2.generateAssertionWithCode] access token not returned in the exchange code result: ",o)},function(e){r(e)})})}(n,o,c))}else o({name:"IdPLoginError",loginUrl:r(n)})},function(e){reject(e)})},getAccessTokenAuthorisationEndpoint:(e,n)=>{console.log("[OAUTH2.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[OAUTH2.getAccessTokenAuthorisationEndpoint:resources]",n),a=e.accessTokenAuthorisationEndpoint;return new Promise(function(e,o){e(a(n))},function(e){reject(e)})},getAccessToken:(e,n,o)=>{console.log("[OAUTH2.getAccessToken:config]",e),console.log("[OAUTH2.getAccessToken:login]",o),c=e.accessTokenEndpoint,i=e.domain;return new Promise(function(e,t){let s=g(o),r=f(o,"access_token");e(r?k(n,r,s,o):function(e,n){return new Promise(function(o,t){let s=f(n,"code");s||t("[OAUTH2.getAccessTokenWithCodeToken] code not returned by the login result: ",n),p("POST",c(s,e)).then(function(n){if(console.info("[OAUTH2.getAccessTokenWithCodeToken] HTTP response: ",n),n.hasOwnProperty("access_token")){let t=g(n),s=!!n.hasOwnProperty("refresh_token")&&n.refresh_token;o(k(e,n.access_token,t,n,s))}else t("[OAUTH2.getAccessTokenWithCodeToken] access token not returned in the exchange code result: ",n)},function(e){t(e)})})}(n,o))},function(e){reject(e)})},refreshAccessToken:(e,n)=>{console.log("[OAUTH2.refreshAccessToken:config]",e),console.log("[OAUTH2.refreshAccessToken:outdated token]",n),u=e.refreshAccessTokenEndpoint,i=e.domain;return new Promise(function(e,o){let t=n.refresh;t||o("[OAUTH2.refreshAccessToken] refresh token not available in the access token",n),p("POST",u(t)).then(function(s){if(console.info("[OAUTH2.refreshAccessToken] response: ",s),s.hasOwnProperty("access_token")){let o=function(e){let n=!!e.hasOwnProperty("expires_in")&&e.expires_in;return n?n+=Math.floor(Date.now()/1e3):n=31536e5+Math.floor(Date.now()/1e3),Number(n)}(s);e(k(n.resources,s.access_token,o,s,t))}else o("[OAUTH2.refreshAccessToken] new access token not returned in the response: ",s)},function(e){o(e)})},function(e){reject(e)})},revokeAccessToken:(e,n)=>{console.log("[OAUTH2.revokeAccessToken:config]",e),console.log("[OAUTH2.revokeAccessToken: token]",n),l=e.revokeAccessTokenEndpoint,i=e.domain;return new Promise(function(e,o){n.refresh||o("[OAUTH2.revokeAccessToken] refresh token not available in the access token",n),p("POST",l(n.accessToken)).then(function(n){console.info("[OAUTH2.revokeAccessToken] response: ",n),e(!0)},function(e){o(e)})},function(e){reject(e)})}}},,,,,,function(e,n,o){"use strict";o.r(n);var t=o(1);let s=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),r={clientID:"516850078685290",authorisationEndpoint:"https://www.facebook.com/v2.11/dialog/oauth?",userinfo:"https://graph.facebook.com/v2.2/me/?fields=id,first_name,last_name,name,picture,email&access_token=",type:"token",granted_scopes:"email,public_profile",state:"state",domain:"facebook.com"};function i(e){return console.log("[FaceboolUserProfileConverter] ",e),e.name=e.first_name+" "+e.last_name,e.userURL="user://facebook.com/"+e.name,e.picture=e.picture.data.url,e.hasOwnProperty("preferred_username")||(e.preferred_username=e.last_name),e}function c(e){return r.userinfo+e.access_token}function a(e){let n=r.authorisationEndpoint+"redirect_uri="+s+"&response_type="+r.type+"&client_id="+r.clientID+"&granted_scopes="+r.granted_scopes+"&nonce="+e+"&state="+e;return console.log("[Slack.authorisationEndpoint] ",n),n}function u(e){return r.userinfo+e.access_token}var l=o(0);const f={name:"FacebookIdpProxyProtoStub",language:"javascript",description:"IDPProxy for Facebook idp",signature:"",configuration:{},constraints:{browser:!0},interworking:!1,objectName:"facebook.com"};n.default=class extends l.a{constructor(){super()}_start(e,n,o){o.idpUrl="domain-idp://facebook.com",o.domain="facebook.com",o.idpProxy=t.a,o.convertUserProfile=i,o.userInfoEndpoint=c,o.authorisationEndpoint=a,o.validateAssertionEndpoint=u,super._init(e,n,o)}get descriptor(){return f}get name(){return f.name}}}]))}}});