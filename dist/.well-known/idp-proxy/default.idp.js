!function(e,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define("activate",[],o):"object"==typeof exports?exports.activate=o():e.activate=o()}("undefined"!=typeof self?self:this,function(){return function(e){var o={};function t(n){if(o[n])return o[n].exports;var r=o[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,t),r.l=!0,r.exports}return t.m=e,t.c=o,t.d=function(e,o,n){t.o(e,o)||Object.defineProperty(e,o,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=0)}([function(e,o,t){"use strict";Object.defineProperty(o,"__esModule",{value:!0});var n=t(1),r=t(2),s=t(3),i=t(4);function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,o){for(var t=0;t<o.length;t++){var n=o[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,o){return!o||"object"!==c(o)&&"function"!=typeof o?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):o}function f(e,o,t){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,o,t){var n=function(e,o){for(;!Object.prototype.hasOwnProperty.call(e,o)&&null!==(e=l(e)););return e}(e,o);if(n){var r=Object.getOwnPropertyDescriptor(n,o);return r.get?r.get.call(t):r.value}})(e,o,t||e)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,o){return(p=Object.setPrototypeOf||function(e,o){return e.__proto__=o,e})(e,o)}var g={name:"GoogleIdpProxyProtoStub",language:"javascript",description:"IDPProxy for google idp",signature:"",configuration:{},constraints:{browser:!0},interworking:!0,objectName:"google.com"},d=function(e){function o(){return function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,o),u(this,l(o).call(this))}return function(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),o&&p(e,o)}(o,i["a"]),function(e,o,t){o&&a(e.prototype,o),t&&a(e,t)}(o,[{key:"_start",value:function(e,t,i){console.log("[GoogleIdpProxyProtoStub._start] "),i.domain="google.com",i.idpUrl="domain-idp://google.com",i.idpProxy=n.a,i.idpInfo=r.f,i.apiInfo=r.e,i.accessTokenAuthorisationEndpoint=r.a,i.accessTokenEndpoint=r.b,i.refreshAccessTokenEndpoint=r.h,i.revokeAccessTokenEndpoint=r.i,i.accessTokenInput=r.c,i.authorisationEndpoint=r.d,i.convertUserProfile=s.a,i.mapping=r.g,f(l(o.prototype),"_init",this).call(this,e,t,i)}},{key:"descriptor",get:function(){return g}},{key:"name",get:function(){return g.name}}]),o}();o.default=d},function(e,o,t){"use strict";t.d(o,"a",function(){return h});var n,r,s,i,c,a={},u=0,f=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),l=function(e){var o=!!e.hasOwnProperty("expires_in")&&e.expires_in;return o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3),Number(o)};function p(e,o){o=o.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\#&?]"+o+"=([^&#]*)").exec(e);return null!==t&&t[1]}function g(e,o){var t=new XMLHttpRequest;return"withCredentials"in t?t.open(e,o,!0):"undefined"!=typeof XDomainRequest?(t=new XDomainRequest).open(e,o):t=null,new Promise(function(e,o){t?(t.onreadystatechange=function(n){if(4===t.readyState)if(200===t.status){var r=JSON.parse(t.responseText);e(r)}else 400===t.status?o("There was an error processing the token"):o("something else other than 200 was returned")},t.send()):o("CORS not supported")})}var d=function(e,o,t,n,r){var i={domain:s,resources:e,accessToken:o,expires:t,input:n};return r&&(i.refresh=r),i},h={validateAssertion:function(e,o,t){console.info("[OIDC.validateAssertionProxy] assertion: ",atob(o));var n=atob(o),r=JSON.parse(n).tokenID.split(".");JSON.parse(atob(r[1]));return new Promise(function(t,n){var r=e.idpInfo,s=atob(o),i=JSON.parse(s);g("GET",r.tokenInfo+i.tokenID).then(function(e){JSON.stringify(e)===JSON.stringify(i.tokenIDJSON)?t({identity:i.tokenIDJSON.email,contents:i.tokenIDJSON}):n("invalid")}).catch(function(e){n(e)})})},refreshAssertion:function(e){return console.log("OIDC.refreshAssertion:oldIdentity",e),new Promise(function(o,t){o(e)})},generateAssertion:function(e,o,t,n){console.log("[OIDC.generateAssertion:contents]",o),console.log("[OIDC.generateAssertion:origin]",t),console.log("[OIDC.generateAssertion:hint]",n);var r=e.idpInfo;return new Promise(function(e,t){if(n){var s=p(n,"access_token"),i=p(n,"id_token");p(n,"code");g("GET",r.userinfo+s).then(function(o){console.log("[OIDC.generateAssertion] obtained infoToken ",o),g("GET",r.tokenInfo+i).then(function(t){console.log("[OIDC.generateAssertion] obtained idToken ",t);var n={assertion:btoa(JSON.stringify({tokenID:i,tokenIDJSON:t})),idp:{domain:r.domain,protocol:"OIDC"},expires:t.exp,userProfile:o,refresh:!0};a[u]=n,++u,console.log("[OIDC.generateAssertion] returning: ",JSON.stringify(n)),e(n)},function(e){t(e)})},function(e){t(e)})}else{var c=r.authorisationEndpoint+"redirect_uri="+f+"&prompt=consent&response_type="+r.type+"&client_id="+r.clientID+"&scope="+r.scope+"&access_type="+r.accessType+"&nonce="+o+"&state="+r.state;console.log("[OIDC.generateAssertion] NO_HINT: rejecting with requestUrl ",c),t({name:"IdPLoginError",loginUrl:c})}})},getAccessTokenAuthorisationEndpoint:function(e,o){console.log("[OIDC.getAccessTokenAuthorisationEndpoint:config]",e),console.log("[OIDC.getAccessTokenAuthorisationEndpoint:resources]",o),i=e.accessTokenAuthorisationEndpoint;var t=e.mapping;return new Promise(function(e,n){e(i(t(o)))},function(e){reject(e)})},getAccessToken:function(e,o,t){console.log("[OIDC.getAccessToken:config]",e),console.log("[OIDC.getAccessToken:login]",t),n=e.accessTokenEndpoint,s=e.domain;return new Promise(function(e,r){var s=function(e){var o=p(e,"expires_in");return o?o+=Math.floor(Date.now()/1e3):o=31536e5+Math.floor(Date.now()/1e3),Number(o)}(t),i=p(t,"access_token");e(i?d(o,i,s,t):function(e,o){return new Promise(function(t,r){var s=p(o,"code");s||r("[OIDC.getAccessTokenWithCodeToken] code not include in the url: ",o),g("POST",n(s)).then(function(o){if(console.info("[OIDC.getAccessTokenWithCodeToken] response: ",o),o.hasOwnProperty("access_token")){var n=l(o),s=!!o.hasOwnProperty("refresh_token")&&o.refresh_token;t(d(e,o.access_token,n,o,s))}else r("[OIDC.getAccessTokenWithCodeToken] access token not returned in the exchange code result: ",o)},function(e){r(e)})})}(o,t))},function(e){reject(e)})},refreshAccessToken:function(e,o){console.log("[OIDC.refreshAccessToken:config]",e),console.log("[OIDC.refreshAccessToken:outdated token]",o),r=e.refreshAccessTokenEndpoint,s=e.domain;return new Promise(function(e,t){var n=o.refresh;n||t("[OIDC.refreshAccessToken] refresh token not available in the access token",o),g("POST",r(n)).then(function(r){if(console.info("[OIDC.refreshAccessToken] response: ",r),r.hasOwnProperty("access_token")){var s=l(r);e(d(o.resources,r.access_token,s,r,n))}else t("[OIDC.refreshAccessToken] new access token not returned in the response: ",r)},function(e){t(e)})},function(e){reject(e)})},revokeAccessToken:function(e,o){console.log("[OIDC.revokeAccessToken:config]",e),console.log("[OIDC.revokeAccessToken: token]",o),c=e.revokeAccessTokenEndpoint,s=e.domain;return new Promise(function(e,t){o.refresh||t("[OIDC.revokeAccessToken] refresh token not available in the access token",o),g("POST",c(o.accessToken)).then(function(o){console.info("[OIDC.revokeAccessToken] response: ",o),e(!0)},function(e){t(e)})},function(e){reject(e)})}}},function(e,o,t){"use strict";t.d(o,"f",function(){return r}),t.d(o,"e",function(){return s}),o.b=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&code="+e+"&grant_type=authorization_code&access_type=offline&client_secret="+s.secret+"&redirect_uri="+n},o.h=function(e){return s.tokenEndpoint+"client_id="+s.clientID+"&refresh_token="+e+"&grant_type=refresh_token&client_secret="+s.secret},o.i=function(e){return s.revokeEndpoint+"&token="+e},o.g=function(e){if(!e)return"fitness.location.read%20https://www.googleapis.com/auth/fitness.activity.read";switch(e){case"user_activity_context":default:return"fitness.location.read%20https://www.googleapis.com/auth/fitness.activity.read"}},o.a=function(e){var o=s.authorisationEndpoint+"redirect_uri="+n+"&response_type="+s.type+"&client_id="+s.clientID+"&scope=https://www.googleapis.com/auth/"+e+"&access_type="+s.accessType+"&state="+s.state;return console.log("[GoogleInfo.accessTokenAuthorisationEndpoint] ",o),o},o.d=function(e){var o=s.authorisationEndpoint+"redirect_uri="+n+"&response_type="+s.type+"&client_id="+s.clientID+"&scope="+s.scope+"&access_type="+s.accessType+"&state="+e;return console.log("[GoogleInfo.authorisationEndpoint] ",o),o},o.c=function(e){return{info:e}};var n=location.protocol+"//"+location.hostname+(""!==location.port?":"+location.port:""),r={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"online",type:"token id_token",scope:"openid%20email%20profile",state:"state",domain:"google.com"},s={clientID:"808329566012-tqr8qoh111942gd2kg007t0s8f277roi.apps.googleusercontent.com",issuer:"https://accounts.google.com",tokenEndpoint:"https://www.googleapis.com/oauth2/v4/token?",revokeEndpoint:"https://accounts.google.com/o/oauth2/revoke?",jwksUri:"https://www.googleapis.com/oauth2/v3/certs?",authorisationEndpoint:"https://accounts.google.com/o/oauth2/auth?",userinfo:"https://www.googleapis.com/oauth2/v3/userinfo?access_token=",tokenInfo:"https://www.googleapis.com/oauth2/v3/tokeninfo?id_token=",accessType:"offline",type:"code",scope:"https://www.googleapis.com/auth/fitness.location.read",state:"state",domain:"google.com",grant_type:"authorization_code",secret:"Xx4rKucb5ZYTaXlcZX9HLfZW"}},function(e,o,t){"use strict";o.a=function(e){e.userURL="user://google.com/"+e.email,e.hasOwnProperty("preferred_username")||(e.preferred_username=e.email.split("@")[0]);return e}},function(e,o,t){"use strict";function n(e,o){for(var t=0;t<o.length;t++){var n=o[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var r,s,i,c=function(){function e(){!function(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}(this,e),console.log("[AbstractIdpProxy] constructor")}return function(e,o,t){o&&n(e.prototype,o),t&&n(e,t)}(e,[{key:"_init",value:function(e,o,t){var n=this;n.runtimeProtoStubURL=e,n.messageBus=o,n.config=t,r=t.idpProxy,s=t.convertUserProfile,i=t.accessTokenInput,n.messageBus.addListener("*",function(e){e.to===t.idpUrl&&n.requestToIdp(e)}),n._sendStatus("created")}},{key:"requestToIdp",value:function(e){var o=this,t=e.body.params;switch(console.info("[AbstractIdpProxyProtoStub] receiving request: ",e),e.body.method){case"generateAssertion":r.generateAssertion(o.config,t.contents,t.origin,t.usernameHint).then(function(t){t.userProfile=s(t.userProfile),o.replyMessage(e,t)},function(t){o.replyMessage(e,t,401)});break;case"validateAssertion":r.validateAssertion(o.config,t.assertion,t.origin).then(function(t){o.replyMessage(e,t)},function(t){o.replyMessage(e,t)});break;case"refreshAssertion":r.refreshAssertion(t.identity).then(function(t){o.replyMessage(e,t)},function(t){o.replyMessage(e,t,value,401)});break;case"getAccessTokenAuthorisationEndpoint":r.getAccessTokenAuthorisationEndpoint(o.config,t.resources).then(function(t){o.replyMessage(e,t)},function(t){o.replyMessage(e,t,401)});break;case"getAccessToken":r.getAccessToken(o.config,t.resources,t.login).then(function(t){console.info("OIDC.getAccessToken result: ",t),t.input=i(t.input),o.replyMessage(e,t)},function(t){o.replyMessage(e,t,401)});break;case"refreshAccessToken":r.refreshAccessToken(o.config,t.token).then(function(t){console.info("OIDC.refreshAccessToken result: ",t),o.replyMessage(e,t)},function(t){o.replyMessage(e,t,401)});break;case"revokeAccessToken":r.revokeAccessToken(o.config,t.token).then(function(t){console.info("OIDC.revokeAccessToken result: ",t),o.replyMessage(e,t)},function(t){o.replyMessage(e,t,401)})}}},{key:"replyMessage",value:function(e,o){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:200,n={id:e.id,type:"response",to:e.from,from:e.to,body:{code:t}};t<300?n.body.value=o:n.body.description=o,console.log("[AbstractIdpProxyProtoStub.replyMessage] ",n),this.messageBus.postMessage(n)}},{key:"_sendStatus",value:function(e,o){console.log("[AbstractIdpProxyProtoStub.sendStatus] ",e),this._state=e;var t={type:"update",from:this.runtimeProtoStubURL,to:this.runtimeProtoStubURL+"/status",body:{value:e}};o&&(t.body.desc=o),this.messageBus.postMessage(t)}}]),e}();o.a=c}]).default});