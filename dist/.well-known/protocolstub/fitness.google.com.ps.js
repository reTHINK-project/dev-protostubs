System.register([],function(e){return{execute:function(){e(function(e){var t={};function r(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(s,o,function(t){return e[t]}.bind(null,o));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=57)}({13:function(e,t,r){"use strict";r.d(t,"a",function(){return s});class s{constructor(){}_init(e,t,r,s,o){if(this._stubName=o,!e)throw new Error("The runtimeProtoStubURL is a needed parameter");if(!t)throw new Error("The bus is a needed parameter");if(!r)throw new Error("The config is a needed parameter");if(!r.runtimeURL)throw new Error("The config.runtimeURL is a needed parameter");let n=this;console.log(`[${this._stubName}] PROTOSTUB`,n),this._id=0,this._runtimeProtoStubURL=e,this._bus=t,this._config=r,this._domain=r.domain,this._runtimeSessionURL=r.runtimeURL,this._syncher=s.createSyncher(e,t,r),this._userActivityVertxHypertyURL="hyperty://sharing-cities-dsm/user-activity",n._sendStatus("created"),n.started=!1;t.addListener("*",e=>{if(console.log(`${n._stubName} new Message  : `,e),e.identity&&(n._identity=e.identity),"delete"===e.type)return void n.stopWorking();if(e.hasOwnProperty("body")&&e.body.hasOwnProperty("identity")){if(e.body.identity.accessToken){n._accessToken=e.body.identity.accessToken;let t={id:e.id,type:"response",from:e.to,to:e.from,body:{code:200,runtimeURL:n._runtimeSessionURL}};console.log(n),n._bus.postMessage(t)}n.hypertyJSUrl=e.from}const t="hyperty-catalogue://catalogue."+n._domain+"/.well-known/dataschema/Context",r={id:"1276020076",values:[{type:"user_walking_context",name:"walking distance in meters",unit:"meter",value:0,startTime:"2018-03-25T12:00:00Z",endTime:"2018-03-25T12:10:00Z"},{type:"user_biking_context",name:"biking distance in meters",unit:"meter",value:0,startTime:"2018-03-26T12:00:00Z",endTime:"2018-03-26T12:10:00Z"}]};n._accessToken&&!n.started&&"create"===e.type&&n._resumeReporters("user_activity",e.to).then(function(s){console.log(`[${n._stubName}._resumeReporters (result)  `,s),0==s?n._setUpReporter(n._identity,t,r,["context"],"user_activity",e.to).then(function(e){e&&n.startWorking(e,!1)}):n.startWorking(s,!0)}).catch(function(e){})})}get descriptor(){return protostubDescriptor}get name(){return protostubDescriptor.name}startWorking(e,t){let r=this;function s(){const t=e.metadata.created;let s=e.metadata.lastModified;s||(s=t),r.querySessions(t,s),r.startInterval=setInterval(function(){(s=e.metadata.lastModified)||(s=t),r.querySessions(t,s)},r.config.sessions_query_interval),r.started=!0}r.reporter=e,r.hasStartedQuerying=!1,t&&(r.hasStartedQuerying=!0,s()),e.onSubscription(function(e){e.accept(),console.log(`${r._stubName} new subs`,e),r.hasStartedQuerying||(r.hasStartedQuerying=!0,s())}),console.log(`${r._stubName} User activity DO created: `,e),e.inviteObservers([r._userActivityVertxHypertyURL])}stopWorking(){clearInterval(this.startInterval),this.started=!1}_setUpReporter(e,t,r,s,o,n){let i=this;return new Promise(function(a,u){let c={resources:s,expires:3600,reporter:n,domain_registration:!1,domain_routing:!1};i._syncher.create(t,[],r,!0,!1,o,e,c).then(e=>{console.log(`${i._stubName} REPORTER RETURNED`,e),a(e)}).catch(function(e){console.error(`${i._stubName} err`,e),a(null)})})}_resumeReporters(e,t){let r=this;return new Promise((s,o)=>{r._syncher.resumeReporters({store:!0,reporter:t}).then(o=>{console.log(`[${r._stubName} Reporters resumed`,o);let n=Object.keys(o);if(!(n.length>0))return s(!1);n.forEach(n=>{if(console.log(`[${r._stubName}`,n),console.log(`[${r._stubName}`,o[n]),t==o[n].metadata.reporter&&o[n].metadata.name==e)return s(o[n])})}).catch(e=>{console.info(`[${r._stubName} Reporters:`,e)})})}querySessions(e,t){}writeToReporter(e,t,r,s){let o,n;"bike"===e?(o="user_biking_context",n="biking distance in meters"):"walk"===e&&(o="user_walking_context",n="walking distance in meters"),this.reporter.data.values=[{type:o,name:n,unit:"meter",value:t,startTime:r,endTime:s}]}refreshAccessToken(e,t,r){let s=this;return new Promise((o,n)=>{let i={type:"execute",from:s._runtimeProtoStubURL,to:s._runtimeSessionURL+"/idm",body:{method:"refreshAccessToken",params:{resources:["user_activity_context"],domain:r}}};s._bus.postMessage(i,r=>{console.log(`[${s._stubName}.refreshAccessToken] reply `,r),r.body.hasOwnProperty("value")?(s._accessToken=r.body.value,s.querySessions(e,t),o()):n(r.body)})})}get config(){return this._config}get runtimeSession(){return this._runtimeSessionURL}_sendStatus(e,t){console.log(`[[${this._stubName}] status changed] to `,e),this._state=e;let r={type:"update",from:this._runtimeProtoStubURL,to:this._runtimeProtoStubURL+"/status",body:{value:e}};t&&(r.body.desc=t),this._bus.postMessage(r)}}},57:function(e,t,r){"use strict";r.r(t),r.d(t,"default",function(){return o});var s=r(13);class o extends s.a{constructor(){super()}_start(e,t,r,s){super._init(e,t,r,s,"GoogleProtoStub")}querySessions(e,t){let r=this;e!==t&&(e=t);const s=new Date,o=s.toISOString(),n=s.getTime(),i=new Date(e).getTime();(new XMLHttpRequest).withCredentials=!0,r.getDistanceForActivities(i,n).then(e=>{for(let t=0;t<e.length;t+=1){const s=e[t],n=s.activity,a=s.dataset[0].point[0].value[0].fpVal,u=new Date(i).toISOString();switch(n){case 7:case 8:console.log("[GoogleProtoStub] walking/running distance (m): ",a),r.writeToReporter("walk",a,u,o);break;case 1:console.log("[GoogleProtoStub] biking distance (m): ",a),r.writeToReporter("bike",a,u,o)}}},s=>{if(s.hasOwnProperty("errorCode")&&401===s.errorCode)return r.refreshAccessToken(e,t,"google.com");throw s}).catch(e=>{r._sendStatus("disconnected",e),console.error("[GoogleProtoStub.querySessions] error: ",e)})}getDistanceForActivities(e,t){return new Promise((r,s)=>{const o={aggregateBy:[{dataTypeName:"com.google.distance.delta"}],bucketByActivityType:{minDurationMillis:0},startTimeMillis:e,endTimeMillis:t};var n=new XMLHttpRequest;n.withCredentials=!0,n.addEventListener("readystatechange",function(){if(4===this.readyState){const e=JSON.parse(this.responseText);console.log("[GoogleProtoStub.getDistanceForActivities] response: ",e),e.hasOwnProperty("bucket")?r(e.bucket):e.hasOwnProperty("code")&&e.code>299?s({errorCode:e.code}):s(e)}}),n.open("POST","https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate"),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Authorization","Bearer "+this._accessToken),n.setRequestHeader("Cache-Control","no-cache"),n.send(JSON.stringify(o))})}}}}))}}});